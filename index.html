<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تجريبي - Firebase</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            RecaptchaVerifier,
            signInWithPhoneNumber
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot, 
            updateDoc,
            query,
            orderBy,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
        
        // ============================================
        // FIREBASE CONFIGURATION - استبدلها ببياناتك
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDdPzWgCcpQeb2tP16kaHLxH38_F7EANFU",
            authDomain: "nasimstore20-5bd7c.firebaseapp.com",
            projectId: "nasimstore20-5bd7c",
            storageBucket: "nasimstore20-5bd7c.firebasestorage.app",
            messagingSenderId: "990327087244",
            appId: "1:990327087244:web:6ce012045d2ea701ba1ba9",
            measurementId: "G-7F5630V59P"
        };

        // Initialize Firebase app
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentUser = null;
        let currentUserData = null;
        let usersListener = null;
        window.confirmationResult = null;
        window.recaptchaVerifier = null;

        // ============================================
        // PAGE LOAD INITIALIZATION
        // ============================================
        window.onload = function() {
            try {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => { console.log("reCAPTCHA verified."); }
                });
                console.log("reCAPTCHA Verifier initialized.");
            } catch (error) {
                console.error("Error initializing reCAPTCHA:", error);
            }
        };
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        window.signUp = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const statusDiv = document.getElementById('authStatus');
            try {
                const isFirstUser = (await getDocs(query(collection(db, 'users')))).empty;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const role = isFirstUser ? 'admin' : 'user';
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email, uid: user.uid, role: role, location: null,
                    phone: null, isPhoneVerified: false, createdAt: new Date().toISOString()
                });
                statusDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">تم إنشاء الحساب بنجاح! ${isFirstUser ? 'أنت المدير!' : ''}</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">خطأ: ${error.message}</div>`;
            }
        };
        
        window.signIn = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const statusDiv = document.getElementById('authStatus');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                statusDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">تم تسجيل الدخول بنجاح!</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">خطأ: ${error.message}</div>`;
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                if (usersListener) {
                    usersListener();
                    usersListener = null;
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // ============================================
        // USER PROFILE FUNCTIONS
        // ============================================
        window.shareLocation = async () => {
            const statusDiv = document.getElementById('locationStatus');
            if (!navigator.geolocation) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">المتصفح لا يدعم تحديد الموقع</div>`;
                return;
            }
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    try {
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            location: { latitude, longitude, updatedAt: new Date().toISOString() }
                        });
                        statusDiv.innerHTML = `<div class="bg-green-100 ...">تم حفظ الموقع!</div>`;
                    } catch (error) {
                        statusDiv.innerHTML = `<div class="bg-red-100 ...">خطأ في حفظ الموقع: ${error.message}</div>`;
                    }
                },
                (error) => {
                    statusDiv.innerHTML = `<div class="bg-red-100 ...">خطأ: ${error.message}</div>`;
                }
            );
        };
        
        window.sendVerificationCode = async () => {
            const countryCode = document.getElementById('countryCode').value;
            const localPhoneNumber = document.getElementById('localPhoneNumber').value;
            const phoneNumber = countryCode + localPhoneNumber;
            
            const statusDiv = document.getElementById('phoneStatus');
            const appVerifier = window.recaptchaVerifier;

            if (!localPhoneNumber) {
                statusDiv.innerHTML = `<div class="bg-yellow-100 ...">الرجاء إدخال رقم الهاتف.</div>`;
                return;
            }

            statusDiv.innerHTML = `<div class="bg-blue-100 ...">جاري إرسال رمز التحقق...</div>`;
            
            try {
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                window.confirmationResult = confirmationResult;
                statusDiv.innerHTML = `<div class="bg-green-100 ...">تم إرسال رمز التحقق إلى ${phoneNumber}!</div>`;
                document.getElementById('verificationSection').classList.remove('hidden');
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">خطأ: ${error.message}</div>`;
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
            }
        };
        
        window.verifyCode = async () => {
            const code = document.getElementById('verificationCode').value;
            const statusDiv = document.getElementById('phoneStatus');
            if (!code) {
                 statusDiv.innerHTML = `<div class="bg-yellow-100 ...">الرجاء إدخال الرمز.</div>`;
                 return;
            }
            if (!window.confirmationResult) {
                 statusDiv.innerHTML = `<div class="bg-red-100 ...">خطأ: الرجاء طلب الرمز أولاً.</div>`;
                 return;
            }
            
            try {
                const result = await window.confirmationResult.confirm(code);
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    isPhoneVerified: true,
                    phone: result.user.phoneNumber
                });
                statusDiv.innerHTML = `<div class="bg-green-100 ...">تم التحقق من الرقم! ✓</div>`;
                document.getElementById('verificationSection').classList.add('hidden');
                loadUserData();
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">خطأ: الرمز غير صحيح.</div>`;
            }
        };

        // ============================================
        // ADMIN & UI FUNCTIONS
        // ============================================
        function loadUsersForAdmin() {
            if (currentUserData?.role !== 'admin') return;
            const usersList = document.getElementById('usersList');
            usersListener = onSnapshot(collection(db, 'users'), (snapshot) => {
                let html = '';
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    html += `<div class="border rounded p-4 mb-4 ${userData.role === 'admin' ? 'bg-purple-50' : 'bg-white'}"><div class="grid grid-cols-2 gap-2"><div><span class="font-semibold">البريد:</span> ${userData.email} ${userData.role === 'admin' ? '<span class="ml-2 bg-purple-600 text-white px-2 py-1 rounded text-xs">مدير</span>' : ''}</div><div><span class="font-semibold">الهاتف:</span> ${userData.phone || 'لم يحدد'} ${userData.isPhoneVerified ? '<span class="ml-2 text-green-600">✓ موثق</span>' : '<span class="ml-2 text-gray-400">غير موثق</span>'}</div><div class="col-span-2"><span class="font-semibold">الموقع:</span> ${userData.location ? `Lat: ${userData.location.latitude.toFixed(4)}, Lng: ${userData.location.longitude.toFixed(4)}` : 'غير مشترك'}</div><div class="col-span-2 text-sm text-gray-500"><span class="font-semibold">معرف المستخدم:</span> ${userData.uid}</div></div></div>`;
                });
                usersList.innerHTML = html || '<p class="text-gray-500">لا يوجد مستخدمون مسجلون بعد.</p>';
            });
        }
        window.sendNotification = () => {
            const message = document.getElementById('notificationMessage').value;
            if (!message) { alert('الرجاء إدخال رسالة الإشعار'); return; }
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-4 bg-indigo-600 text-white p-4 rounded-lg shadow-lg max-w-sm z-50 animate-pulse';
            notification.innerHTML = `<div class="flex items-start"><div class="flex-1"><p class="font-semibold">📢 إشعار من المدير</p><p class="mt-1">${message}</p></div><button onclick="this.parentElement.parentElement.remove()" class="mr-4 text-white hover:text-gray-200">✕</button></div>`;
            document.body.appendChild(notification);
            setTimeout(() => { if (notification.parentNode) { notification.remove(); } }, 5000);
            document.getElementById('notificationMessage').value = '';
        };
        async function loadUserData() {
            if (!currentUser) return;
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    document.getElementById('userEmail').textContent = currentUserData.email;
                    document.getElementById('userRole').textContent = currentUserData.role === 'admin' ? 'مدير' : 'مستخدم';
                    document.getElementById('verificationStatus').textContent = currentUserData.isPhoneVerified ? 'موثق ✓' : 'غير موثق';
                    if (currentUserData.role === 'admin') {
                        document.getElementById('adminPanel').classList.remove('hidden');
                        loadUsersForAdmin();
                    } else {
                        document.getElementById('adminPanel').classList.add('hidden');
                    }
                }
            } catch (error) { console.error('Error loading user data:', error); }
        }
        function updateUI(user) {
            const authSection = document.getElementById('authSection');
            const dashboardSection = document.getElementById('dashboardSection');
            if (user) {
                currentUser = user;
                authSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                loadUserData();
            } else {
                currentUser = null;
                currentUserData = null;
                authSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                if (usersListener) {
                    usersListener();
                    usersListener = null;
                }
            }
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        onAuthStateChanged(auth, user => updateUI(user));
        console.log('Firebase app initialized.');
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">🔥 تطبيق تجريبي - Firebase</h1>
            <p class="text-center text-gray-600 mt-2">توثيق، قاعدة بيانات ولوحة تحكم</p>
        </header>

        <div id="authSection" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">التسجيل</h2>
            <div id="authStatus" class="mb-4"></div>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="border rounded-lg p-4 bg-blue-50">
                    <h3 class="text-xl font-semibold mb-4 text-blue-800">إنشاء حساب جديد</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                            <input type="email" id="signupEmail" placeholder="your@email.com" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                            <input type="password" id="signupPassword" placeholder="6 أحرف على الأقل" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <button onclick="signUp()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">إنشاء حساب</button>
                        <p class="text-sm text-gray-600">💡 أول مستخدم يصبح مديراً!</p>
                    </div>
                </div>
                <div class="border rounded-lg p-4 bg-green-50">
                    <h3 class="text-xl font-semibold mb-4 text-green-800">تسجيل الدخول</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                            <input type="password" id="loginPassword" placeholder="كلمة مرورك" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <button onclick="signIn()" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">دخول</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">لوحة التحكم</h2>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">تسجيل الخروج</button>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div><span class="font-semibold text-gray-600">البريد:</span><p id="userEmail">-</p></div>
                        <div><span class="font-semibold text-gray-600">الدور:</span><p id="userRole">-</p></div>
                        <div><span class="font-semibold text-gray-600">حالة الهاتف:</span><p id="verificationStatus">-</p></div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="border rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">📍 مشاركة الموقع</h3>
                        <button onclick="shareLocation()" class="bg-blue-500 text-white px-4 py-2 rounded-md w-full">مشاركة موقعي</button>
                        <div id="locationStatus"></div>
                    </div>
                    <div class="border rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">📱 التحقق من الهاتف</h3>
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                            <div class="flex">
                                <select id="countryCode" class="border border-l-0 border-gray-300 rounded-r-md px-3 py-2 bg-gray-50 focus:outline-none">
                                    <option value="+967" selected>🇾🇪 +967</option>
                                    <option value="+966">🇸🇦 +966</option>
                                    <option value="+971">🇦🇪 +971</option>
                                    <option value="+1">🇺🇸 +1</option>
                                    <option value="+20">🇪🇬 +20</option>
                                </select>
                                <input type="tel" id="localPhoneNumber" placeholder="774123456" class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button onclick="sendVerificationCode()" class="bg-green-500 text-white px-4 py-2 rounded-md w-full">إرسال رمز التحقق</button>
                            <div id="recaptcha-container"></div>
                            <div id="verificationSection" class="hidden space-y-3 mt-4">
                                <input type="text" id="verificationCode" placeholder="أدخل الرمز من رسالة SMS" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <button onclick="verifyCode()" class="bg-purple-500 text-white px-4 py-2 rounded-md w-full">التحقق من الرمز</button>
                            </div>
                        </div>
                        <div id="phoneStatus"></div>
                    </div>
                </div>
            </div>

            <div id="adminPanel" class="hidden">
                <div class="bg-purple-100 border-2 border-purple-300 rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6">👑 لوحة تحكم المدير</h2>
                    <div class="bg-white rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">📢 إرسال إشعار للجميع</h3>
                        <div class="space-y-3">
                            <textarea id="notificationMessage" placeholder="أدخل رسالة الإشعار..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                            <button onclick="sendNotification()" class="bg-purple-600 text-white px-4 py-2 rounded-md w-full">إرسال إشعار</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">👥 المستخدمون المسجلون (تحديث فوري)</h3>
                        <div id="usersList" class="space-y-2"><p class="text-gray-500">جاري تحميل المستخدمين...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
