<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Learning App - Authentication & Admin Panel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            RecaptchaVerifier,
            signInWithPhoneNumber
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot, 
            updateDoc,
            query,
            orderBy,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
        
        // ============================================
        // FIREBASE CONFIGURATION - REPLACE WITH YOUR OWN
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDdPzWgCcpQeb2tP16kaHLxH38_F7EANFU",
            authDomain: "nasimstore20-5bd7c.firebaseapp.com",
            projectId: "nasimstore20-5bd7c",
            storageBucket: "nasimstore20-5bd7c.firebasestorage.app",
            messagingSenderId: "990327087244",
            appId: "1:990327087244:web:6ce012045d2ea701ba1ba9",
            measurementId: "G-7F5630V59P"
        };

        // Initialize Firebase app
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentUser = null;
        let currentUserData = null;
        let usersListener = null;
        window.confirmationResult = null;
        window.recaptchaVerifier = null;

        // ============================================
        // PAGE LOAD INITIALIZATION
        // ============================================
        window.onload = function() {
            try {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => { console.log("reCAPTCHA verified."); }
                });
                console.log("reCAPTCHA Verifier initialized.");
            } catch (error) {
                console.error("Error initializing reCAPTCHA:", error);
            }
        };
        
        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        window.signUp = async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const statusDiv = document.getElementById('authStatus');
            try {
                const isFirstUser = (await getDocs(query(collection(db, 'users')))).empty;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const role = isFirstUser ? 'admin' : 'user';
                await setDoc(doc(db, 'users', user.uid), {
                    email: user.email, uid: user.uid, role: role, location: null,
                    phone: null, isPhoneVerified: false, createdAt: new Date().toISOString()
                });
                statusDiv.innerHTML = `<div class="bg-green-100 ...">Account created! ${isFirstUser ? 'You are ADMIN!' : ''}</div>`;
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">Error: ${error.message}</div>`;
            }
        };
        
        window.signIn = async () => { /* ... (Same as before) ... */ };
        window.logout = async () => { /* ... (Same as before) ... */ };

        // ============================================
        // USER PROFILE FUNCTIONS
        // ============================================
        window.shareLocation = async () => { /* ... (Same as before) ... */ };
        
        /**
         * [Ù…ÙØ­Ø¯Ù‘ÙŽØ«] Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ ØªØ­Ù‚Ù‚ Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø¹Ø¯ Ø¯Ù…Ø¬ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„Ø±Ù‚Ù…
         */
        window.sendVerificationCode = async () => {
            const countryCode = document.getElementById('countryCode').value;
            const localPhoneNumber = document.getElementById('localPhoneNumber').value;
            const phoneNumber = countryCode + localPhoneNumber; // Ø¯Ù…Ø¬ Ø§Ù„Ø±Ù‚Ù…ÙŠÙ†
            
            const statusDiv = document.getElementById('phoneStatus');
            const appVerifier = window.recaptchaVerifier;

            if (!localPhoneNumber) {
                statusDiv.innerHTML = `<div class="bg-yellow-100 ...">Please enter a phone number.</div>`;
                return;
            }

            statusDiv.innerHTML = `<div class="bg-blue-100 ...">Sending verification code...</div>`;
            
            try {
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                window.confirmationResult = confirmationResult;
                statusDiv.innerHTML = `<div class="bg-green-100 ...">Verification code sent to ${phoneNumber}!</div>`;
                document.getElementById('verificationSection').classList.remove('hidden');
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">Error: ${error.message}</div>`;
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                }
            }
        };
        
        /**
         * [Ù…ÙØ­Ø¯Ù‘ÙŽØ«] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
         */
        window.verifyCode = async () => {
            const code = document.getElementById('verificationCode').value;
            const statusDiv = document.getElementById('phoneStatus');
            if (!code) { /* ... */ return; }
            if (!window.confirmationResult) { /* ... */ return; }
            
            try {
                const result = await window.confirmationResult.confirm(code);
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    isPhoneVerified: true,
                    phone: result.user.phoneNumber
                });
                statusDiv.innerHTML = `<div class="bg-green-100 ...">Phone number verified! âœ“</div>`;
                document.getElementById('verificationSection').classList.add('hidden');
                loadUserData();
            } catch (error) {
                statusDiv.innerHTML = `<div class="bg-red-100 ...">Error: Invalid code.</div>`;
            }
        };

        // ============================================
        // ADMIN & UI FUNCTIONS (Remain the same)
        // ============================================
        function loadUsersForAdmin() { /* ... (Same as before) ... */ }
        window.sendNotification = () => { /* ... (Same as before) ... */ };
        async function loadUserData() { /* ... (Same as before) ... */ }
        function updateUI(user) { /* ... (Same as before) ... */ }

        // ============================================
        // INITIALIZE APP
        // ============================================
        onAuthStateChanged(auth, user => updateUI(user));
        console.log('Firebase app initialized.');
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">ðŸ”¥ Firebase Learning App</h1>
            <p class="text-center text-gray-600 mt-2">Authentication, Firestore & Admin Panel</p>
        </header>

        <div id="authSection">
             </div>

        <div id="dashboardSection" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="border rounded-lg p-4">
                        </div>
                    
                    <div class="border rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">ðŸ“± Phone Verification</h3>
                        <div class="space-y-3">
                            
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <div class="flex">
                                <select id="countryCode" class="border border-r-0 border-gray-300 rounded-l-md px-3 py-2 bg-gray-50 focus:outline-none">
                                    <option value="+967" selected>+967 ðŸ‡¾ðŸ‡ª</option>
                                    <option value="+966">+966 ðŸ‡¸ðŸ‡¦</option>
                                    <option value="+971">+971 ðŸ‡¦ðŸ‡ª</option>
                                    <option value="+1">+1 ðŸ‡ºðŸ‡¸</option>
                                    <option value="+20">+20 ðŸ‡ªðŸ‡¬</option>
                                </select>
                                <input type="tel" id="localPhoneNumber" placeholder="774123456" class="w-full px-3 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button onclick="sendVerificationCode()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200 w-full">Send Verification Code</button>
                            <div id="recaptcha-container"></div>
                            
                            <div id="verificationSection" class="hidden space-y-3 mt-4">
                                <input type="text" id="verificationCode" placeholder="Enter code from SMS" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="verifyCode()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition duration-200 w-full">Verify Code</button>
                            </div>
                        </div>
                        <div id="phoneStatus"></div>
                    </div>
                </div>
            </div>

            <div id="adminPanel" class="hidden">
                </div>
        </div>

        <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg shadow-md p-6">
            </div>
    </div>
</body>
</html>
